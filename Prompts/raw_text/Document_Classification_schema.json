{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/schemas/clinical-document-classification-v1.0-D-locked-citations.json",
  "title": "Clinical Document Classification v1.0-D Locked (Citations Extended)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "dominant_type_overall",
    "segments",
    "document_mixture",
    "vendor_signals",
    "number_of_segments",
    "citations_index",
    "self_evaluation"
  ],
  "properties": {
    "dominant_type_overall": {
      "type": "string",
      "enum": [
        "Clinical Note",
        "Radiology Report",
        "Pathology Report",
        "Genomic Report",
        "Other"
      ]
    },

    "segments": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/segment" }
    },

    "document_mixture": {
      "type": "array",
      "minItems": 5,
      "maxItems": 5,
      "items": { "$ref": "#/$defs/documentMixtureEntry" }
    },

    "vendor_signals": {
      "type": "array",
      "items": { "type": "string" }
    },

    "number_of_segments": {
      "type": "integer",
      "minimum": 1
    },

    "citations_index": {
      "type": "array",
      "items": { "$ref": "#/$defs/citationIndexEntry" }
    },

    "self_evaluation": { "$ref": "#/$defs/selfEvaluation" }
  },

  "$defs": {
    "docType": {
      "type": "string",
      "enum": [
        "Clinical Note",
        "Radiology Report",
        "Pathology Report",
        "Genomic Report",
        "Other"
      ]
    },

    "presenceLevel": {
      "type": "string",
      "enum": ["PRIMARY", "EMBEDDED_RAW", "MENTION_ONLY", "NO_EVIDENCE"]
    },

    "bbox": {
      "type": "array",
      "minItems": 4,
      "maxItems": 4,
      "items": { "type": "number" },
      "description": "Bounding box [x1,y1,x2,y2] in page coordinate space (implementation-defined)."
    },

    "citationRef": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "citation_id",
        "page",
        "block_id",
        "line_start",
        "line_end",
        "bbox",
        "source",
        "confidence"
      ],
      "properties": {
        "citation_id": {
          "type": "string",
          "pattern": "^CIT-[0-9]{4,}$"
        },
        "page": { "type": "integer", "minimum": 1 },
        "block_id": {
          "type": "string",
          "minLength": 1,
          "description": "Layout/text block identifier from the parser."
        },
        "line_start": { "type": "integer", "minimum": 0 },
        "line_end": { "type": "integer", "minimum": 0 },
        "bbox": { "$ref": "#/$defs/bbox" },
        "source": {
          "type": "string",
          "enum": ["layout_parser", "pdf_text", "ocr"]
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        }
      }
    },

    "evidenceItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["page", "snippet", "anchors_found", "citations"],
      "properties": {
        "page": { "type": "integer", "minimum": 1 },
        "snippet": {
          "type": "string",
          "minLength": 1,
          "description": "Must include embedded citation tag like: [CIT-0001 p12 b3 l45-62] ..."
        },
        "anchors_found": {
          "type": "array",
          "items": { "type": "string" }
        },
        "citations": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/citationRef" }
        }
      }
    },

    "segmentCompositionEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "document_type",
        "presence_level",
        "confidence",
        "segment_share",
        "top_evidence",
        "reasoning"
      ],
      "properties": {
        "document_type": { "$ref": "#/$defs/docType" },
        "presence_level": { "$ref": "#/$defs/presenceLevel" },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "segment_share": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "top_evidence": {
          "type": "array",
          "minItems": 0,
          "items": { "$ref": "#/$defs/evidenceItem" }
        },
        "reasoning": { "type": "string" }
      },

      "allOf": [
        {
          "if": {
            "properties": { "presence_level": { "const": "NO_EVIDENCE" } },
            "required": ["presence_level"]
          },
          "then": {
            "properties": {
              "confidence": { "const": 0.0 },
              "segment_share": { "const": 0.0 }
            }
          }
        }
      ]
    },

    "segment": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "segment_index",
        "start_page",
        "end_page",
        "segment_page_count",
        "dominant_type",
        "embedded_types",
        "evidence",
        "segment_composition",
        "notes"
      ],
      "properties": {
        "segment_index": { "type": "integer", "minimum": 1 },
        "start_page": { "type": "integer", "minimum": 1 },
        "end_page": { "type": "integer", "minimum": 1 },
        "segment_page_count": { "type": "integer", "minimum": 1 },

        "dominant_type": { "$ref": "#/$defs/docType" },
        "embedded_types": {
          "type": "array",
          "items": { "$ref": "#/$defs/docType" }
        },

        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/evidenceItem" }
        },

        "segment_composition": {
          "type": "array",
          "minItems": 5,
          "maxItems": 5,
          "items": { "$ref": "#/$defs/segmentCompositionEntry" }
        },

        "notes": { "type": "string" }
      },

      "allOf": [
        {
          "description": "segment_page_count must equal end_page - start_page + 1",
          "if": { "required": ["start_page", "end_page", "segment_page_count"] },
          "then": {
            "properties": {
              "segment_page_count": { "type": "integer", "minimum": 1 }
            }
          }
        }
      ]
    },

    "documentMixtureEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "document_type",
        "presence_level",
        "confidence",
        "overall_share",
        "overall_share_explanation",
        "top_evidence",
        "reasoning"
      ],
      "properties": {
        "document_type": { "$ref": "#/$defs/docType" },
        "presence_level": { "$ref": "#/$defs/presenceLevel" },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "overall_share": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "overall_share_explanation": { "type": "string" },
        "top_evidence": {
          "type": "array",
          "minItems": 0,
          "items": { "$ref": "#/$defs/evidenceItem" }
        },
        "reasoning": { "type": "string" }
      },

      "allOf": [
        {
          "if": {
            "properties": { "presence_level": { "const": "NO_EVIDENCE" } },
            "required": ["presence_level"]
          },
          "then": {
            "properties": {
              "confidence": { "const": 0.0 },
              "overall_share": { "const": 0.0 }
            }
          }
        }
      ]
    },

    "citationIndexEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "citation_id",
        "page",
        "block_id",
        "line_start",
        "line_end",
        "bbox",
        "text",
        "source",
        "confidence"
      ],
      "properties": {
        "citation_id": {
          "type": "string",
          "pattern": "^CIT-[0-9]{4,}$"
        },
        "page": { "type": "integer", "minimum": 1 },
        "block_id": { "type": "string", "minLength": 1 },
        "line_start": { "type": "integer", "minimum": 0 },
        "line_end": { "type": "integer", "minimum": 0 },
        "bbox": { "$ref": "#/$defs/bbox" },
        "text": { "type": "string" },
        "source": {
          "type": "string",
          "enum": ["layout_parser", "pdf_text", "ocr"]
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        }
      }
    },

    "selfEvaluation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["evaluation_summary", "changes_made"],
      "properties": {
        "evaluation_summary": { "type": "string" },
        "changes_made": { "type": "string" }
      }
    }
  }
}
